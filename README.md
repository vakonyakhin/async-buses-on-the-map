# Автобусы на карте Москвы

Веб-приложение показывает передвижение автобусов на карте Москвы.

<img src="screenshots/buses.gif">



## Как запустить

- Скачайте код
- Настройке виртуальное окружение и установите зависимости
- Запустите сервер
- запустите имитатор
- Откройте в браузере файл index.html

##

Для установки зависимостей используйте файл requirement.txt

```bash
pip install -r requirements.txt

```

## Запуск сервера
Сервер можно настроить с помощью переменных окружения:

- `HOST` - IP-адрес, на котором будет работать сервер (по умолчанию `127.0.0.1`).
- `PORT` - Порт, на котором будет работать сервер (по умолчанию `8000`).
- `LOG_LEVEL` - Уровень логирования (по умолчанию `INFO`).

Пример запуска с переменными окружениями:

```bash
HOST=0.0.0.0 PORT=8080 LOG_LEVEL=DEBUG unicorn main:app

```
## Запуск имитатора


Имитатор автобусов принимает следующие аргументы командной строки:
- `--server` - Адрес WebSocket сервера (по умолчанию `ws://127.0.0.1:8000/`).
- `--routes_number` - Количество используемых маршрутов (по умолчанию `3`).
- `--buses_per_route` - Количество автобусов на маршрут (по умолчанию `2`).
- `--websockets_number` - Количество WebSocket соединений (по умолчанию `3`).
- `--emulator_id` - Префикс для идентификаторов автобусов (по умолчанию `'0'`).
- `--verbosity` - Уровень детализации логирования (по умолчанию `'DEBUG'`).

пример запуска
```bash
python fake_bus.py --server ws://127.0.0.1:8000/ --routes_number 3 --buses_per_route 2 --websockets_number 3 --emulator_id 0 --verbosity DEBUG

```

## Запуск клиента
- Откройте в браузере файл index.html

Внизу справа на странице можно включить отладочный режим логгирования и указать нестандартный адрес веб-сокета.

<img src="screenshots/settings.png">

Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.

Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.

## Формат данных

Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:

```js
{
  "msgType": "Buses",
  "buses": [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"},
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:

```js
{
  "msgType": "newBounds",
  "data": {
    "east_lng": 37.65563964843751,
    "north_lat": 55.77367652953477,
    "south_lat": 55.72628839374007,
    "west_lng": 37.54440307617188,
  },
}
```


## Используемые библиотеки

- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) для логгирования


## Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).

